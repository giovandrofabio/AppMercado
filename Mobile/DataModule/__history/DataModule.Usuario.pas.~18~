unit DataModule.Usuario;

interface

uses
  System.SysUtils,
  System.Classes,
  Data.DB,
  FireDAC.Stan.Intf,
  FireDAC.Stan.Option,
  FireDAC.Stan.Param,
  FireDAC.Stan.Error,
  FireDAC.DatS,
  FireDAC.Phys.Intf,
  FireDAC.DApt.Intf,
  FireDAC.Comp.DataSet,
  FireDAC.Comp.Client,
  DataSet.Serialize.Config,
  RESTRequest4D,
  System.JSON;

type
  TDmUsuario = class(TDataModule)
    TabUsuario: TFDMemTable;
    procedure DataModuleCreate(Sender: TObject);
  private
    { Private declarations }
  public
    procedure Login(email, senha: string);
    { Public declarations }
  end;

var
  DmUsuario: TDmUsuario;

implementation

{%CLASSGROUP 'FMX.Controls.TControl'}

{$R *.dfm}

const
    USER_NAME = '99coders';
    PASSWORD  = '123456';
    BASE_URL  = 'http://localhost:3000';

procedure TDmUsuario.DataModuleCreate(Sender: TObject);
begin
   TDataSetSerializeConfig.GetInstance.CaseNameDefinition := cndLower;
end;

procedure TDmUsuario.Login(email, senha: string);
var
   resp: IResponse;
   json: TJSONObject;
begin
   json := TJSONObject.Create;
   try
      json.AddPair('email',email);
      json.AddPair('senha',senha);

      resp := TRequest.New.BaseURL(BASE_URL)
              .Resource('usuarios/login')
              .DataSetAdapter(TabUsuario)
              .AddBody(json.ToJSON)
              .Accept('application/json')
              .BasicAuthentication(USER_NAME, PASSWORD)
              .Post;

      if (resp.StatusCode = 400) then
         raise Exception.Create('E-meail ou Senha inválida');


      if (resp.StatusCode <> 200) then
         raise Exception.Create(resp.Content);
   finally
      json.DisposeOf;
   end;
end;

end.
